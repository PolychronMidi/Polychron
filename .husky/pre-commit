#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# Polychron Pre-commit Guard
# Prevents commits with file integrity issues
node scripts/pre-commit.js || exit 1

# Docs: fix (prefer npm, fallback to direct node invocation, otherwise skip)
echo "Running docs:fix..."
if command -v npm >/dev/null 2>&1; then
  npm run docs:fix || exit 1
else
  node scripts/docs.js fix || echo "Warning: docs:fix failed or node missing; skipping"
fi

# Docs: check
echo "Running docs:check..."
if command -v npm >/dev/null 2>&1; then
  npm run docs:check || exit 1
else
  node scripts/docs.js check || echo "Warning: docs:check failed or node missing; skipping"
fi

# Lint (prefer npm, fallback to local eslint if available, otherwise skip)
echo "Running lint..."
if command -v npm >/dev/null 2>&1; then
  npm run lint -- --max-warnings=0 || exit 1
else
  if command -v eslint >/dev/null 2>&1; then
    eslint src/**/*.{js,ts} --max-warnings=0 || exit 1
  else
    echo "Warning: eslint not found; skipping lint in pre-commit"
  fi
fi

# Type-check (prefer npm, fallback to tsc if available, otherwise skip)
echo "Running type-check..."
if command -v npm >/dev/null 2>&1; then
  npm run type-check || exit 1
else
  if command -v tsc >/dev/null 2>&1; then
    tsc --noEmit || exit 1
  else
    echo "Warning: tsc not found; skipping type-check in pre-commit"
  fi
fi
